parameters:
  - name: testsPath
  - name: loadTestResourceName

steps:
  - task: AzureCLI@2
    displayName: Deploy Load tests
    inputs:
      azureSubscription: $(serviceConnection)
      scriptType: pscore
      scriptLocation: inlineScript
      useGlobalConfig: false
      inlineScript: |
        Install-Module powershell-yaml -force
        Set-PSDebug -Trace 1

        Write-Host("#### testsPath: {0}" -f "${{ parameters.testsPath }}")
        Write-Host("#### loadTestResourceName: {0}" -f $Env:LOADTEST_RESOURCE_NAME)

        $directories = Get-ChildItem "${{ parameters.testsPath }}"
        foreach ($d in $directories) {
          Write-Host("#### Processing test: {0}" -f $d.FullName)
          if(!(Test-Path "$d/config.yaml" -PathType Leaf)) {
            Write-Host("#### Skipping directory {0} as it does not contain a config.yaml file" -f $d.FullName)
            continue
          }
          if(!(Test-Path "$d/test.jmx" -PathType Leaf)) {
            Write-Host("#### Skipping directory {0} as it does not contain a test.jmx file" -f $d.FullName)
            continue
          }
          $config = (Get-Content "$d/config.yaml" -Raw) | ConvertFrom-Yaml
          $testId = $config.testId
          $displayName = $config.displayName
          $description = $config.description
          $engineInstances = $config.engineInstances
          Write-Host("az load test create --load-test-resource $Env:LOADTEST_RESOURCE_NAME --test-id $testId  --display-name $displayName --description $description --test-plan test.jmx --engine-instances $engineInstances")
        }
    env:
      LOADTEST_RESOURCE_NAME: ${{ parameters.loadTestResourceName }}