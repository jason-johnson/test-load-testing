parameters:
  - name: testsPath
  - name: loadTestResourceName

steps:
  - task: AzureCLI@2
    displayName: Deploy Load tests
    inputs:
      azureSubscription: $(serviceConnection)
      scriptType: pscore
      scriptLocation: inlineScript
      useGlobalConfig: false
      inlineScript: |
        Install-Module powershell-yaml
        Set-PSDebug -Trace 2

        Write-Host("#### testsPath: {0}" -f "${{ parameters.testsPath }}")
        Write-Host("#### loadTestResourceName: {0}" -f $Env:LOADTEST_RESOURCE_NAME)

        $directories = Get-ChildItem "${{ parameters.testsPath }}"
        foreach ($d in $directories) {
          Write-Host("#### Processing test: {0}" -f $d.FullName)
          if(!(Test-Path "$d/config.yaml" -PathType Leaf)) {
            Write-Host("#### Skipping directory {0} as it does not contain a config.yaml file" -f $d.FullName)
            continue
          }
          $config = (Get-Content "$d/config.yaml" -Raw) | ConvertFrom-Yaml
          Write-Host("#### testId: {0}" -f $config.testId)
        }
    env:
      LOADTEST_RESOURCE_NAME: ${{ parameters.loadTestResourceName }}

#        az load test create --load-test-resource  ${{ parameters.loadTestResourceName }} --test-id $testId  --display-name "My CLI Load Test" --description "Created using Az CLI" --test-plan $testPlan --engine-instances 1